<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suspense æµ‹è¯•</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .app-container {
        max-width: 900px;
        margin: 0 auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      h2 {
        margin-bottom: 20px;
        color: #333;
      }
      h3 {
        margin: 20px 0 10px;
        color: #666;
        font-size: 16px;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        background: #1976d2;
        color: #fff;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: #1565c0;
      }
      button.danger {
        background: #d32f2f;
      }
      button.danger:hover {
        background: #c62828;
      }
      button.success {
        background: #388e3c;
      }
      button.success:hover {
        background: #2e7d32;
      }
      .info {
        padding: 10px;
        background: #e3f2fd;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 14px;
        color: #1565c0;
      }
      .test-box {
        border: 2px dashed #42b883;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        min-height: 80px;
      }
      .loading {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 20px;
        background: #fff3e0;
        border-radius: 8px;
        color: #e65100;
      }
      .loading::before {
        content: "";
        width: 20px;
        height: 20px;
        border: 3px solid #ffb74d;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .loaded {
        padding: 20px;
        background: #e8f5e9;
        border-radius: 8px;
        color: #2e7d32;
      }
      .error {
        padding: 20px;
        background: #ffebee;
        border-radius: 8px;
        color: #c62828;
      }
      .log-container {
        background: #263238;
        color: #aed581;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 13px;
        max-height: 200px;
        overflow-y: auto;
      }
      .log-item {
        padding: 2px 0;
      }
      .log-item.pending {
        color: #ffb74d;
      }
      .log-item.fallback {
        color: #4fc3f7;
      }
      .log-item.resolve {
        color: #81c784;
      }
      .log-item.timeout {
        color: #e57373;
      }
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
      }
      .status-badge.pending {
        background: #fff3e0;
        color: #e65100;
      }
      .status-badge.resolved {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .nested-suspense {
        border: 2px solid #9c27b0;
        padding: 15px;
        margin: 10px;
        border-radius: 8px;
      }
      .nested-suspense::before {
        content: "åµŒå¥— Suspense";
        display: block;
        font-size: 12px;
        color: #9c27b0;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import {
        render,
        h,
        ref,
        reactive,
        Suspense,
        onMounted,
      } from "./runtime-dom.esm.js";

      // ========== æ—¥å¿—ç³»ç»Ÿ ==========
      const logs = reactive([]);
      const addLog = (type, message) => {
        const time = new Date().toLocaleTimeString();
        logs.push({ type, message, time });
      };
      const clearLogs = () => {
        logs.length = 0;
      };

      // ========== æ¨¡æ‹Ÿå»¶è¿Ÿå‡½æ•° ==========
      const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

      // ========== å¼‚æ­¥ç»„ä»¶ 1ï¼šåŸºç¡€å¼‚æ­¥ ==========
      const AsyncComponent = {
        name: "AsyncComponent",
        async setup() {
          addLog("pending", "AsyncComponent: å¼€å§‹åŠ è½½...");

          // æ¨¡æ‹Ÿå¼‚æ­¥è¯·æ±‚
          await delay(2000);

          addLog("resolve", "AsyncComponent: åŠ è½½å®Œæˆ!");

          const count = ref(0);

          onMounted(() => {
            addLog("resolve", "AsyncComponent: onMounted è§¦å‘");
          });

          return () =>
            h("div", { class: "loaded" }, [
              h("p", "âœ… å¼‚æ­¥ç»„ä»¶åŠ è½½æˆåŠŸï¼"),
              h("p", `è®¡æ•°å™¨: ${count.value}`),
              h("button", { onClick: () => count.value++ }, "å¢åŠ "),
            ]);
        },
      };

      // ========== å¼‚æ­¥ç»„ä»¶ 2ï¼šå¿«é€ŸåŠ è½½ ==========
      const FastAsyncComponent = {
        name: "FastAsyncComponent",
        async setup() {
          addLog("pending", "FastAsyncComponent: å¼€å§‹åŠ è½½...");
          await delay(500);
          addLog("resolve", "FastAsyncComponent: åŠ è½½å®Œæˆ!");

          return () => h("div", { class: "loaded" }, "âš¡ å¿«é€Ÿå¼‚æ­¥ç»„ä»¶ï¼ˆ500msï¼‰");
        },
      };

      // ========== å¼‚æ­¥ç»„ä»¶ 3ï¼šæ…¢é€ŸåŠ è½½ï¼ˆç”¨äºæµ‹è¯•è¶…æ—¶ï¼‰==========
      const SlowAsyncComponent = {
        name: "SlowAsyncComponent",
        async setup() {
          addLog("pending", "SlowAsyncComponent: å¼€å§‹åŠ è½½...");
          await delay(5000);
          addLog("resolve", "SlowAsyncComponent: åŠ è½½å®Œæˆ!");

          return () => h("div", { class: "loaded" }, "ğŸ¢ æ…¢é€Ÿå¼‚æ­¥ç»„ä»¶ï¼ˆ5ç§’ï¼‰");
        },
      };

      // ========== åŒæ­¥ç»„ä»¶ï¼ˆå¯¹ç…§ï¼‰==========
      const SyncComponent = {
        name: "SyncComponent",
        setup() {
          return () => h("div", { class: "loaded" }, "ğŸ“¦ æˆ‘æ˜¯åŒæ­¥ç»„ä»¶ï¼ˆæ— éœ€ç­‰å¾…ï¼‰");
        },
      };

      // ========== Loading ç»„ä»¶ ==========
      const Loading = {
        setup() {
          return () => h("div", { class: "loading" }, "åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...");
        },
      };

      // ========== æ—¥å¿—é¢æ¿ç»„ä»¶ ==========
      const LogPanel = {
        setup() {
          return () =>
            h("div", { class: "log-container" }, [
              logs.length === 0
                ? h("div", { class: "log-item" }, "æš‚æ— æ—¥å¿—...")
                : logs.map((log, i) =>
                    h("div", { class: `log-item ${log.type}`, key: i }, [
                      `[${log.time}] `,
                      `[${log.type.toUpperCase()}] `,
                      log.message,
                    ])
                  ),
            ]);
        },
      };

      // ========== ä¸»åº”ç”¨ ==========
      const App = {
        setup() {
          const showBasic = ref(false);
          const showFast = ref(false);
          const showTimeout = ref(false);
          const showSync = ref(false);
          const showMultiple = ref(false);
          const showNested = ref(false);

          return () =>
            h("div", { class: "app-container" }, [
              h("h2", "Suspense ç»„ä»¶æµ‹è¯•"),

              // æ—¥å¿—é¢æ¿
              h("h3", "äº‹ä»¶æ—¥å¿—"),
              h(LogPanel),
              h("button", { class: "danger", onClick: clearLogs }, "æ¸…ç©ºæ—¥å¿—"),

              // ========== æµ‹è¯• 1ï¼šåŸºç¡€ Suspense ==========
              h("h3", [
                "1. åŸºç¡€ Suspense",
                showBasic.value
                  ? h("span", { class: "status-badge pending" }, "åŠ è½½ä¸­")
                  : null,
              ]),
              h(
                "p",
                { class: "info" },
                "æµ‹è¯•ç‚¹ï¼šasync setup + fallback/default åˆ‡æ¢"
              ),
              h(
                "button",
                { onClick: () => (showBasic.value = !showBasic.value) },
                showBasic.value ? "éšè—" : "æ˜¾ç¤ºå¼‚æ­¥ç»„ä»¶"
              ),
              h("div", { class: "test-box" }, [
                showBasic.value
                  ? h(
                      Suspense,
                      {
                        onPending: () => addLog("pending", "Suspense: onPending"),
                        onFallback: () => addLog("fallback", "Suspense: onFallback"),
                        onResolve: () => addLog("resolve", "Suspense: onResolve"),
                      },
                      {
                        default: () => h(AsyncComponent),
                        fallback: () => h(Loading),
                      }
                    )
                  : h("p", "ç‚¹å‡»æŒ‰é’®åŠ è½½å¼‚æ­¥ç»„ä»¶"),
              ]),

              // ========== æµ‹è¯• 2ï¼šå¿«é€Ÿå¼‚æ­¥ç»„ä»¶ ==========
              h("h3", "2. å¿«é€Ÿå¼‚æ­¥ç»„ä»¶ï¼ˆ500msï¼‰"),
              h(
                "p",
                { class: "info" },
                "æµ‹è¯•ç‚¹ï¼šçŸ­æ—¶é—´å†… resolveï¼Œfallback é—ªçƒé—®é¢˜"
              ),
              h(
                "button",
                { onClick: () => (showFast.value = !showFast.value) },
                showFast.value ? "éšè—" : "æ˜¾ç¤º"
              ),
              h("div", { class: "test-box" }, [
                showFast.value
                  ? h(
                      Suspense,
                      {
                        onPending: () => addLog("pending", "Fast Suspense: onPending"),
                        onResolve: () => addLog("resolve", "Fast Suspense: onResolve"),
                      },
                      {
                        default: () => h(FastAsyncComponent),
                        fallback: () => h(Loading),
                      }
                    )
                  : h("p", "ç‚¹å‡»æŒ‰é’®åŠ è½½"),
              ]),

              // ========== æµ‹è¯• 3ï¼šåŒæ­¥ç»„ä»¶ï¼ˆæ— éœ€ Suspenseï¼‰==========
              h("h3", "3. åŒæ­¥ç»„ä»¶ï¼ˆå¯¹ç…§æµ‹è¯•ï¼‰"),
              h(
                "p",
                { class: "info" },
                "æµ‹è¯•ç‚¹ï¼šåŒæ­¥ç»„ä»¶åº”è¯¥ç›´æ¥æ˜¾ç¤ºï¼Œä¸æ˜¾ç¤º fallback"
              ),
              h(
                "button",
                { onClick: () => (showSync.value = !showSync.value) },
                showSync.value ? "éšè—" : "æ˜¾ç¤º"
              ),
              h("div", { class: "test-box" }, [
                showSync.value
                  ? h(
                      Suspense,
                      {
                        onPending: () => addLog("pending", "Sync Suspense: onPending"),
                        onFallback: () =>
                          addLog("fallback", "Sync Suspense: onFallback (ä¸åº”è¯¥è§¦å‘!)"),
                        onResolve: () => addLog("resolve", "Sync Suspense: onResolve"),
                      },
                      {
                        default: () => h(SyncComponent),
                        fallback: () => h(Loading),
                      }
                    )
                  : h("p", "ç‚¹å‡»æŒ‰é’®åŠ è½½"),
              ]),

              // ========== æµ‹è¯• 4ï¼šè¶…æ—¶å¤„ç† ==========
              h("h3", "4. è¶…æ—¶å¤„ç†ï¼ˆtimeout: 3000msï¼‰"),
              h(
                "p",
                { class: "info" },
                "æµ‹è¯•ç‚¹ï¼šç»„ä»¶åŠ è½½è¶…è¿‡ 3 ç§’è§¦å‘ onTimeout"
              ),
              h(
                "button",
                { onClick: () => (showTimeout.value = !showTimeout.value) },
                showTimeout.value ? "éšè—" : "æ˜¾ç¤ºæ…¢é€Ÿç»„ä»¶"
              ),
              h("div", { class: "test-box" }, [
                showTimeout.value
                  ? h(
                      Suspense,
                      {
                        timeout: 3000,
                        onPending: () => addLog("pending", "Timeout Suspense: onPending"),
                        onFallback: () => addLog("fallback", "Timeout Suspense: onFallback"),
                        onResolve: () => addLog("resolve", "Timeout Suspense: onResolve"),
                        onTimeout: () => addLog("timeout", "Timeout Suspense: âš ï¸ è¶…æ—¶äº†ï¼"),
                      },
                      {
                        default: () => h(SlowAsyncComponent),
                        fallback: () => h(Loading),
                      }
                    )
                  : h("p", "ç‚¹å‡»æŒ‰é’®åŠ è½½ï¼ˆä¼šè¶…æ—¶ï¼‰"),
              ]),

              // ========== æµ‹è¯• 5ï¼šå¤šä¸ªå¼‚æ­¥ç»„ä»¶ ==========
              h("h3", "5. å¤šä¸ªå¼‚æ­¥ç»„ä»¶"),
              h(
                "p",
                { class: "info" },
                "æµ‹è¯•ç‚¹ï¼šSuspense å†…å¤šä¸ªå¼‚æ­¥ç»„ä»¶ï¼Œå…¨éƒ¨ resolve åæ‰åˆ‡æ¢"
              ),
              h(
                "button",
                { onClick: () => (showMultiple.value = !showMultiple.value) },
                showMultiple.value ? "éšè—" : "æ˜¾ç¤º"
              ),
              h("div", { class: "test-box" }, [
                showMultiple.value
                  ? h(
                      Suspense,
                      {
                        onPending: () => addLog("pending", "Multiple: onPending"),
                        onFallback: () => addLog("fallback", "Multiple: onFallback"),
                        onResolve: () =>
                          addLog("resolve", "Multiple: onResolve (å…¨éƒ¨å®Œæˆ)"),
                      },
                      {
                        default: () => [
                          h(FastAsyncComponent),
                          h(AsyncComponent),
                        ],
                        fallback: () => h(Loading),
                      }
                    )
                  : h("p", "ç‚¹å‡»æŒ‰é’®åŠ è½½å¤šä¸ªå¼‚æ­¥ç»„ä»¶"),
              ]),

              // ========== æµ‹è¯• 6ï¼šåµŒå¥— Suspense ==========
              h("h3", "6. åµŒå¥— Suspense"),
              h(
                "p",
                { class: "info" },
                "æµ‹è¯•ç‚¹ï¼šå†…å±‚ Suspense ç‹¬ç«‹å¤„ç†è‡ªå·±çš„å¼‚æ­¥ä¾èµ–"
              ),
              h(
                "button",
                { onClick: () => (showNested.value = !showNested.value) },
                showNested.value ? "éšè—" : "æ˜¾ç¤º"
              ),
              h("div", { class: "test-box" }, [
                showNested.value
                  ? h(
                      Suspense,
                      {
                        onPending: () => addLog("pending", "Outer: onPending"),
                        onFallback: () => addLog("fallback", "Outer: onFallback"),
                        onResolve: () => addLog("resolve", "Outer: onResolve"),
                      },
                      {
                        default: () => [
                          h(FastAsyncComponent),
                          h("div", { class: "nested-suspense" }, [
                            h(
                              Suspense,
                              {
                                suspensible: false, // ä¸å‘çˆ¶çº§å†’æ³¡
                                onPending: () => addLog("pending", "  Inner: onPending"),
                                onFallback: () => addLog("fallback", "  Inner: onFallback"),
                                onResolve: () => addLog("resolve", "  Inner: onResolve"),
                              },
                              {
                                default: () => h(AsyncComponent),
                                fallback: () =>
                                  h("div", { class: "loading" }, "å†…å±‚åŠ è½½ä¸­..."),
                              }
                            ),
                          ]),
                        ],
                        fallback: () => h(Loading),
                      }
                    )
                  : h("p", "ç‚¹å‡»æŒ‰é’®æµ‹è¯•åµŒå¥— Suspense"),
              ]),

              // ========== æµ‹è¯•è¯´æ˜ ==========
              h("h3", "æµ‹è¯•è¯´æ˜"),
              h("div", { class: "info" }, [
                h("p", "âœ… é¢„æœŸè¡Œä¸ºï¼š"),
                h("ul", { style: "margin: 10px 0 0 20px;" }, [
                  h("li", "åŸºç¡€æµ‹è¯•ï¼šæ˜¾ç¤º Loading â†’ 2ç§’åæ˜¾ç¤ºå†…å®¹"),
                  h("li", "å¿«é€Ÿç»„ä»¶ï¼šLoading é—ªç° â†’ 500ms åæ˜¾ç¤ºå†…å®¹"),
                  h("li", "åŒæ­¥ç»„ä»¶ï¼šç›´æ¥æ˜¾ç¤ºå†…å®¹ï¼Œä¸æ˜¾ç¤º Loading"),
                  h("li", "è¶…æ—¶æµ‹è¯•ï¼š3ç§’åæ—¥å¿—æ˜¾ç¤ºè¶…æ—¶ï¼Œ5ç§’åç»„ä»¶åŠ è½½å®Œæˆ"),
                  h("li", "å¤šç»„ä»¶ï¼šç­‰å¾…æœ€æ…¢çš„ç»„ä»¶ï¼ˆ2ç§’ï¼‰å®Œæˆåä¸€èµ·æ˜¾ç¤º"),
                  h("li", "åµŒå¥—ï¼šå¤–å±‚å…ˆå®Œæˆï¼ˆ500msï¼‰ï¼Œå†…å±‚ç‹¬ç«‹ç­‰å¾…ï¼ˆ2ç§’ï¼‰"),
                ]),
              ]),
            ]);
        },
      };

      render(h(App), document.getElementById("app"));
    </script>
  </body>
</html>
